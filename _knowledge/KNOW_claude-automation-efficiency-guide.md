# Claude Code 自动化效率指南

> **Source**: Internal Best Practice (项目实践总结)
> **Date**: 2025-12-18
> **Core Theme**: 决定何时用脚本自动化 vs Claude 手动执行

---

## Golden Rule (黄金准则)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   🏆  "十同一异，脚本无疑；五下独特，手动稳妥"                                │
│                                                                             │
│   ─────────────────────────────────────────────────────────────────────     │
│                                                                             │
│   完整版:                                                                   │
│                                                                             │
│       ┌─────────────────────────────────────────────────────────────┐       │
│       │                                                             │       │
│       │   N ≥ 10  +  规则统一  +  Git 可回滚  →  写脚本              │       │
│       │                                                             │       │
│       │   N < 5   +  每个不同  +  需要判断    →  手动执行            │       │
│       │                                                             │       │
│       └─────────────────────────────────────────────────────────────┘       │
│                                                                             │
│   ─────────────────────────────────────────────────────────────────────     │
│                                                                             │
│   口诀解释:                                                                 │
│                                                                             │
│   • 十同一异 = 10+ 个文件，同样的规则，只有 ID/值不同                        │
│   • 脚本无疑 = 毫不犹豫写脚本                                               │
│   • 五下独特 = 5 个以下文件，每个情况独特                                    │
│   • 手动稳妥 = Claude 手动处理更合适                                        │
│                                                                             │
│   ─────────────────────────────────────────────────────────────────────     │
│                                                                             │
│   安全前提 (Script Safety):                                                 │
│                                                                             │
│   ✅ 文件在 Git 控制下 → 可安全跳过备份                                     │
│   ⚠️ 涉及生产/用户数据 → 必须 dry-run + backup                             │
│   ❌ 不可逆操作 → 先确认再执行                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**一句话版本**:
> "超过十个且规则相同，写脚本；少于五个且各不相同，手动做。"

---

## The Essence (核心精华)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      AUTOMATION DECISION FRAMEWORK                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                         ┌─────────────────┐                                 │
│                         │   任务分析      │                                 │
│                         │   Task Analysis │                                 │
│                         └────────┬────────┘                                 │
│                                  │                                          │
│                    ┌─────────────┴─────────────┐                            │
│                    │                           │                            │
│                    ▼                           ▼                            │
│         ┌─────────────────┐         ┌─────────────────┐                     │
│         │  Repetitive?    │         │  One-off?       │                     │
│         │  重复性操作?     │         │  一次性任务?    │                     │
│         └────────┬────────┘         └────────┬────────┘                     │
│                  │                           │                              │
│           Yes ◄──┴──► No              Yes ◄──┴──► No                        │
│            │         │                 │         │                          │
│            ▼         ▼                 ▼         ▼                          │
│   ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐               │
│   │  SCRIPT    │ │  考虑手动  │ │  MANUAL    │ │  SCRIPT    │               │
│   │  脚本自动化 │ │  评估复杂度│ │  手动执行  │ │  考虑复用  │               │
│   └────────────┘ └────────────┘ └────────────┘ └────────────┘               │
│                                                                             │
│   ─────────────────────────────────────────────────────────────────────     │
│                                                                             │
│   SCRIPT 脚本适用                      MANUAL 手动适用                       │
│   ┌─────────────────────────┐         ┌─────────────────────────┐           │
│   │ • N > 10 files          │         │ • N < 5 files           │           │
│   │ • Pattern is uniform    │         │ • Each case is unique   │           │
│   │ • Transformation rules  │         │ • Requires judgment     │           │
│   │   can be codified       │         │ • Context-dependent     │           │
│   └─────────────────────────┘         └─────────────────────────┘           │
│                                                                             │
│   ─────────────────────────────────────────────────────────────────────     │
│                                                                             │
│   💡 核心洞见: 文件数量 × 规则统一性 = 自动化收益                             │
│      If files > 10 AND rules are uniform → Script saves hours               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Executive Summary

**反直觉洞见**: 在与 AI 协作的时代，「用 AI 直接执行」并非总是最高效的选择。

当面对批量操作（如修改 44 个 JSON 文件），写一个脚本让 Claude 执行往往比让 Claude 逐个手动修改快 **10-100 倍**。关键判断标准不是任务本身的复杂度，而是「操作的重复性」和「规则的统一性」。

**本指南适用于**：
- 使用 Claude Code 进行软件开发的工程师
- 需要决定「自动化」vs「手动」的团队
- 希望优化 AI 协作效率的个人开发者

---

## 1. 任务分类决策表

### 1.1 核心决策矩阵

| 场景特征 | 文件数量 | 规则统一性 | 推荐方式 | 原因 |
|----------|----------|------------|----------|------|
| ID 系统迁移 | 44 个 | 高（统一映射表） | **Script** | 规则明确，批量执行 |
| Bug 修复 | 1-3 个 | 低（每个不同） | **Manual** | 需要理解上下文 |
| 代码格式化 | 全项目 | 高（统一规则） | **Script** (prettier/eslint) | 工具已存在 |
| 新功能开发 | 若干 | 低（创造性） | **Manual** | 需要设计决策 |
| 数据验证 | N 个 | 高（统一 schema） | **Script** | 规则可编码 |
| 文档更新 | 1-2 个 | 低 | **Manual** | 需要人工判断 |

### 1.2 快速判断流程

```
Task Analysis Flow:
├── Q1: 操作对象数量 > 10?
│   ├── Yes → 继续 Q2
│   └── No → 倾向 Manual
│
├── Q2: 操作规则可统一描述?
│   ├── Yes → 继续 Q3
│   └── No → Manual (每个需要独立判断)
│
├── Q3: 规则是否已有现成工具?
│   ├── Yes → 直接使用现有工具
│   └── No → 继续 Q4
│
└── Q4: 脚本编写成本 < 手动执行成本?
    ├── Yes → Script (写脚本)
    └── No → Manual (直接手动)
```

---

## 2. 脚本自动化适用场景

### 2.1 最佳场景特征

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    SCRIPT AUTOMATION SWEET SPOT                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   高                                                                        │
│    ▲                    ┌────────────────────┐                              │
│    │                    │   AUTOMATION       │                              │
│    │                    │   SWEET SPOT       │                              │
│   规                    │   ★ ID Migration   │                              │
│   则                    │   ★ Batch rename   │                              │
│   统                    │   ★ Schema update  │                              │
│   一                    └────────────────────┘                              │
│   性                                                                        │
│    │     ┌────────────────────┐                                             │
│    │     │   CASE BY CASE     │                                             │
│    │     │   视情况而定        │                                             │
│    │     └────────────────────┘                                             │
│   低 ────┴─────────────────────────────────────────────────▶                │
│           少                    文件数量                    多               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 典型适用任务

| 任务类型 | 描述 | 示例 |
|----------|------|------|
| **Batch Transformation** | 批量格式转换 | JSON schema 升级 |
| **ID Migration** | ID 系统重构 | AT01 → DM1-IS01-AT01 |
| **File Renaming** | 批量文件重命名 | 统一命名规范 |
| **Data Validation** | 数据完整性检查 | 验证所有必填字段 |
| **Index Generation** | 索引文件生成 | atoms_index.json |
| **Cross-file Sync** | 跨文件同步 | YAML → JSON 同步 |

---

## 3. 案例分析: ID 迁移项目

### 3.1 项目概述

**任务**: 将 44 个 Atom JSON 文件的 ID 从扁平编号迁移到层级编号

```
Before:                          After:
┌──────────────────────┐         ┌──────────────────────────────┐
│ AT01_heel_landing    │   ──▶   │ DM1-IS01-AT01_heel_landing   │
│ AT16_shoulder_lift   │   ──▶   │ DM2-IS04-AT16_shoulder_lift  │
│ AT32_contact_high    │   ──▶   │ DM3-IS08-AT32_contact_high   │
└──────────────────────┘         └──────────────────────────────┘
```

### 3.2 方案对比

| 方案 | 执行方式 | 预估时间 | Token 消耗 | 错误风险 |
|------|----------|----------|------------|----------|
| **A: Claude 手动** | 逐个文件读取、修改 | 2-4 小时 | ~500K tokens | 高（人为遗漏） |
| **B: Script 自动** | 编写脚本一次执行 | 10 分钟 | ~20K tokens | 低（统一逻辑） |

**选择**: 方案 B

### 3.3 脚本设计流程

```
Migration Script Pipeline:
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   Step 1: Build Mapping Table                                               │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  READ issue-atoms.yaml                                              │   │
│   │       │                                                             │   │
│   │       ▼                                                             │   │
│   │  GENERATE mapping = {                                               │   │
│   │    AT01: { dim: "DM1", issue: "DM1-IS01", new_id: "DM1-IS01-AT01" } │   │
│   │    AT02: { dim: "DM1", issue: "DM1-IS01", new_id: "DM1-IS01-AT02" } │   │
│   │    ...                                                              │   │
│   │  }                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                          │                                                  │
│                          ▼                                                  │
│   Step 2: Transform Each Atom JSON                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  FOR each file in atoms/*.json:                                     │   │
│   │    1. READ file content                                             │   │
│   │    2. EXTRACT old_id from filename (AT01)                           │   │
│   │    3. LOOKUP new_id from mapping                                    │   │
│   │    4. UPDATE meta.atom_id, hierarchy.dimension_id, ...              │   │
│   │    5. WRITE updated content                                         │   │
│   │    6. RENAME file to new format                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                          │                                                  │
│                          ▼                                                  │
│   Step 3: Regenerate Index                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  SCAN atoms/ directory                                              │   │
│   │  BUILD atoms_index.json with new structure                          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                          │                                                  │
│                          ▼                                                  │
│   Step 4: Update YAML Source                                                │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  UPDATE issue-atoms.yaml                                            │   │
│   │    - Add dimension_id to each dimension                             │   │
│   │    - Update issue.id to new format                                  │   │
│   │    - Update atom.id to new format                                   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                          │                                                  │
│                          ▼                                                  │
│   Step 5: Verify Results                                                    │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  CHECK file_count === 44                                            │   │
│   │  CHECK index_entries === 44                                         │   │
│   │  PRINT sample results for human review                              │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 执行结果

```
=== Migration Results ===

Files processed:     44 / 44
Index entries:       44 / 44
YAML updated:        ✓
Execution time:      ~3 seconds

Sample transformations:
  AT01 → DM1-IS01-AT01 (heel_landing)
  AT16 → DM2-IS04-AT16 (shoulder_lift)
  AT32 → DM3-IS08-AT32 (contact_too_high)
```

### 3.5 经验总结

| Before (手动方案) | After (脚本方案) |
|-------------------|------------------|
| 逐个读取 44 个文件 | 一次性批量处理 |
| 手动计算新 ID | 映射表自动生成 |
| 容易遗漏字段 | 统一更新所有字段 |
| 2-4 小时 | 10 分钟（含编写脚本） |

---

## 4. Claude 手动执行适用场景

### 4.1 最佳场景特征

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    MANUAL EXECUTION SWEET SPOT                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   特征                        说明                                          │
│   ────────────────────────────────────────────────────────────────────      │
│                                                                             │
│   ✓ Judgment Required         需要理解上下文做决策                          │
│   ✓ Creative Work             创造性工作（设计、架构）                       │
│   ✓ Small Scope               影响范围小（1-5 个文件）                       │
│   ✓ Unique Cases              每个情况都不同                                │
│   ✓ Exploratory               探索性任务（不确定方向）                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 典型适用任务

| 任务类型 | 描述 | 原因 |
|----------|------|------|
| **Bug Fixing** | 修复具体 bug | 需要理解根因 |
| **Feature Development** | 新功能开发 | 需要设计决策 |
| **Code Review** | 代码审查 | 需要综合判断 |
| **Architecture Design** | 架构设计 | 创造性工作 |
| **Documentation** | 编写文档 | 需要组织语言 |
| **Debugging** | 调试分析 | 需要推理 |

---

## 5. 并行执行策略

### 5.1 Claude Code 并行能力

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    PARALLEL EXECUTION PATTERNS                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Pattern 1: Parallel Tool Calls                                            │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   Claude Message                                                    │   │
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │   │
│   │   │ Read file A │  │ Read file B │  │ Read file C │                │   │
│   │   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                │   │
│   │          │                │                │                        │   │
│   │          └────────────────┴────────────────┘                        │   │
│   │                           │                                         │   │
│   │                           ▼                                         │   │
│   │                    All results at once                              │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   Pattern 2: Parallel Agents (Task Tool)                                    │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   Main Claude                                                       │   │
│   │        │                                                            │   │
│   │   ┌────┴────┬────────────┐                                          │   │
│   │   ▼         ▼            ▼                                          │   │
│   │ Agent 1   Agent 2    Agent 3                                        │   │
│   │ (Explore) (Plan)     (Execute)                                      │   │
│   │   │         │            │                                          │   │
│   │   └────┬────┴────────────┘                                          │   │
│   │        ▼                                                            │   │
│   │   Aggregate Results                                                 │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 何时使用并行

| 场景 | 并行方式 | 示例 |
|------|----------|------|
| 读取多个独立文件 | Parallel Tool Calls | 同时读取 config + schema + data |
| 执行多个独立命令 | Parallel Bash | git status + npm test |
| 探索多个代码区域 | Parallel Agents | 搜索 API + 搜索 Components |

---

## 6. 错误防护清单

### 6.1 脚本自动化的安全措施

```
Safety Checklist for Batch Operations:
├── [ ] Dry-run 模式
│       在真正执行前，先打印将要做的操作
│
├── [ ] Backup 备份
│       对于不可逆操作，先备份原始数据
│
├── [ ] Verification 验证
│       执行后检查结果数量是否符合预期
│
├── [ ] Sample Output 样本检查
│       打印几个样本结果供人工确认
│
└── [ ] Rollback Plan 回滚方案
        如果出错，知道如何恢复
```

### 6.2 何时跳过安全措施

当以下条件**全部满足**时，可以跳过 dry-run 和 backup:

1. **Version Control**: 所有文件都在 Git 控制下
2. **Clean State**: 当前没有未提交的更改
3. **Reversible**: 操作可以通过 `git checkout` 撤销
4. **Low Risk**: 不涉及生产环境或用户数据

---

## Key Takeaways

### For Individual Engineers

1. **问自己 "N > 10?"** — 当操作对象超过 10 个且规则统一时，写脚本
2. **让 Claude 写脚本，而非执行脚本** — 脚本本身是 Claude 的交付物
3. **善用并行** — 独立的读取操作、Agent 任务可以并行执行
4. **验证优先于备份** — 在 Git 控制下，验证比备份更重要

### For Teams

1. **建立脚本库** — 将常用的批量操作脚本沉淀为项目资产
2. **统一自动化标准** — 定义哪些任务用脚本，哪些用手动
3. **Code Review 脚本** — 脚本也需要 review，尤其是批量修改脚本

### For Tech Leads

1. **识别自动化机会** — 当看到团队成员手动重复操作时，考虑脚本化
2. **平衡投入产出** — 脚本编写成本 vs 手动执行成本
3. **文档化脚本** — 让脚本可复用，下次类似任务直接调用

---

## Sources

- **案例来源**: Tennis Forehand Rubrics 项目 ID 迁移实践
- **脚本位置**: `webapp-v5-api/scripts/migrate_ids.js`
- **执行日期**: 2025-12-18

---

## Appendix: 决策速查表

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         QUICK DECISION TABLE                                │
├─────────────────┬──────────────┬─────────────────┬─────────────────────────┤
│ 操作类型         │ 文件数量      │ 规则统一性       │ 推荐方式                │
├─────────────────┼──────────────┼─────────────────┼─────────────────────────┤
│ ID 迁移          │ 44           │ 高              │ Script ✓               │
│ Bug 修复         │ 1-3          │ 低              │ Manual ✓               │
│ Schema 升级      │ N (大量)      │ 高              │ Script ✓               │
│ 新功能           │ 若干          │ 低              │ Manual ✓               │
│ 格式化           │ 全项目        │ 高              │ 现有工具 (prettier)     │
│ 文档更新         │ 1-2          │ 低              │ Manual ✓               │
│ 数据验证         │ N            │ 高              │ Script ✓               │
│ 代码重构         │ 若干          │ 中              │ Case by case           │
└─────────────────┴──────────────┴─────────────────┴─────────────────────────┘
```
