# VSCode Extension Host 文件竞争条件：为什么 Edit 工具总是失败

> **Source**: 实战 Bug 调查复盘
> **Context**: Claude Code VSCode Extension 中 Edit 工具反复报错 "File has been unexpectedly modified"
> **Date**: 2025-12-21
> **Core Theme**: VSCode Extension Host 的 FileSystemWatcher 机制导致的工具层冲突

---

## Golden Rule (黄金准则)

🏆 **「Extension 写文件，FileWatcher 会打架；绕过 VSCode 层，sed 命令直接改」**

**完整版**:
- Edit 工具连续失败 + 无外部编辑器打开 → 考虑 Extension Host 竞争
- 需要批量修改 + 绕过 VSCode 层 → 使用 `Bash(sed)` 直接操作
- 单次编辑 + VSCode 稳定 → 正常使用 Edit 工具

**一句话版本**:
> 当 Edit 工具反复报 "unexpectedly modified"，但没有其他编辑器打开时，用 `Bash(sed)` 绕过 VSCode Extension 层。

---

## The Essence (核心精华)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│               VSCode Extension Host 文件竞争条件                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   正常路径 (Edit 工具):                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                         │   │
│   │   Claude CLI  ──▶  VSCode Extension Host  ──▶  FileSystemWatcher       │   │
│   │       │                     │                        │                  │   │
│   │       │ "写入文件"          │ "检测变更"             │ "文件已修改!"    │   │
│   │       ▼                     ▼                        ▼                  │   │
│   │   ┌─────────┐         ┌─────────┐              ┌─────────┐             │   │
│   │   │  Edit   │ ───────▶│ 写入中  │◀─── 竞争 ───▶│ 检测中  │             │   │
│   │   │  Tool   │         │         │              │         │             │   │
│   │   └─────────┘         └─────────┘              └─────────┘             │   │
│   │                             │                        │                  │   │
│   │                             └────────┬───────────────┘                  │   │
│   │                                      ▼                                  │   │
│   │                              "File unexpectedly                         │   │
│   │                               modified by user                          │   │
│   │                               or linter"                                │   │
│   │                                                                         │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│   ─────────────────────────────────────────────────────────────────────────     │
│                                                                                 │
│   绕过路径 (Bash sed):                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                         │   │
│   │   Claude CLI  ──▶  Bash(sed)  ──▶  直接写入文件系统                      │   │
│   │       │                │                   │                            │   │
│   │       │                │                   │                            │   │
│   │       ▼                ▼                   ▼                            │   │
│   │   ┌─────────┐    ┌─────────┐         ┌─────────┐                       │   │
│   │   │  sed    │───▶│ 写入完成 │ ───────▶│ 成功!   │                       │   │
│   │   │ command │    │         │         │         │                       │   │
│   │   └─────────┘    └─────────┘         └─────────┘                       │   │
│   │                                                                         │   │
│   │   ✅ 绕过 VSCode Extension Host，无 FileWatcher 竞争                     │   │
│   │                                                                         │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│   💡 核心洞见: Edit 工具经过 VSCode 层 → 触发 FileWatcher → 产生竞争            │
│              Bash(sed) 直接操作文件系统 → 无 VSCode 参与 → 无竞争               │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 目录

- [1. 问题背景](#1-问题背景)
- [2. 调查过程](#2-调查过程)
- [3. 根因分析](#3-根因分析)
- [4. 解决方案](#4-解决方案)
- [5. Transferable Rules](#5-transferable-rules)
- [6. Key Takeaways](#6-key-takeaways)

---

## 1. 问题背景

### 1.1 错误现象

使用 Claude Code 的 Edit 工具修改 `research.sh` 时，反复出现以下错误：

```
File has been unexpectedly modified since you read it
(either by user, linter, or some other process)
```

### 1.2 关键线索

| 观察 | 结论 |
|------|------|
| VSCode/Cursor 没有打开相关标签页 | 不是手动编辑导致 |
| 没有配置 Prettier/ESLint | 不是 Linter 自动格式化 |
| Git hooks 都是 `.sample` 文件 | 不是 Git 钩子触发 |
| 连续多次 Edit 都失败 | 系统性问题，非偶发 |

### 1.3 反直觉点

**问题**: 没有任何编辑器打开文件，为什么系统说文件被修改了？

---

## 2. 调查过程

### 2.1 排除法调查时间线

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          调查时间线                                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Step 1: 检查 VSCode 配置                                                        │
│  ─────────────────────────────────────────────────────────────────────────────  │
│  $ ls .vscode/settings.json                                                     │
│  → 文件不存在                                                                   │
│  结论: 不是 VSCode 工作区配置导致                                                │
│                                                                                 │
│  Step 2: 检查 Git Hooks                                                          │
│  ─────────────────────────────────────────────────────────────────────────────  │
│  $ ls .git/hooks/                                                               │
│  → 全部是 .sample 文件，无活跃钩子                                               │
│  结论: 不是 Git hooks 导致                                                       │
│                                                                                 │
│  Step 3: 检查 Linter/Formatter 配置                                              │
│  ─────────────────────────────────────────────────────────────────────────────  │
│  $ ls -la | grep -E "(prettier|eslint|stylelint)"                               │
│  → 无匹配文件                                                                   │
│  结论: 不是代码格式化工具导致                                                    │
│                                                                                 │
│  Step 4: 观察 system-reminder 消息                                               │
│  ─────────────────────────────────────────────────────────────────────────────  │
│  系统提示: "modified by user or linter"                                          │
│  关键信息: 修改发生在 Read 和 Edit 之间的极短时间内                               │
│                                                                                 │
│  Step 5: 用户确认                                                                │
│  ─────────────────────────────────────────────────────────────────────────────  │
│  用户: "VSCode/Cursor 没有打开任何相关标签页"                                     │
│  用户: "另一台电脑也没有打开这个项目"                                             │
│  → 100% 排除人工编辑                                                            │
│                                                                                 │
│  Step 6: 定位真正原因                                                            │
│  ─────────────────────────────────────────────────────────────────────────────  │
│  Claude Code 运行在 VSCode Extension 内                                          │
│  Extension Host 有 FileSystemWatcher 监听文件变更                                │
│  Edit 工具写入 → 触发 Watcher → Watcher 触发事件 → 检测到"修改"                  │
│                                                                                 │
│  💡 结论: Extension Host 自己的 FileWatcher 和 Edit 工具产生竞争                  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 关键发现

VSCode Extension Host 机制：

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    VSCode Extension Host 架构                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                        VSCode / Cursor                                  │   │
│   │                                                                         │   │
│   │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                │   │
│   │   │   Editor    │    │  Extension  │    │   File      │                │   │
│   │   │   UI        │    │   Host      │    │   System    │                │   │
│   │   │             │    │             │    │   Watcher   │                │   │
│   │   └──────┬──────┘    └──────┬──────┘    └──────┬──────┘                │   │
│   │          │                  │                  │                        │   │
│   │          │                  │                  │                        │   │
│   └──────────┼──────────────────┼──────────────────┼────────────────────────┘   │
│              │                  │                  │                            │
│              │           ┌──────┴──────┐           │                            │
│              │           │   Claude    │           │                            │
│              │           │   Code      │◀──────────┘                            │
│              │           │  Extension  │  监听文件变更                          │
│              │           └──────┬──────┘                                        │
│              │                  │                                               │
│              │           ┌──────┴──────┐                                        │
│              │           │   Edit      │                                        │
│              │           │   Tool      │                                        │
│              │           └──────┬──────┘                                        │
│              │                  │                                               │
│              │                  ▼                                               │
│              │           ┌─────────────┐                                        │
│              │           │  写入文件   │───────────┐                            │
│              │           └─────────────┘           │                            │
│              │                                     ▼                            │
│              │                              ┌─────────────┐                     │
│              │                              │ FileWatcher │                     │
│              │                              │ 检测到变更  │                     │
│              │                              └──────┬──────┘                     │
│              │                                     │                            │
│              │                                     ▼                            │
│              │                              ┌─────────────┐                     │
│              │                              │ "文件被修改"│                     │
│              │                              │  事件触发   │                     │
│              │                              └─────────────┘                     │
│                                                                                 │
│   💡 问题: Edit 工具和 FileWatcher 在同一个 Extension Host 里                    │
│           → 自己写入的变更被自己检测到                                           │
│           → 报错 "unexpectedly modified"                                        │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 根因分析

### 3.1 为什么 Edit 工具会失败

| 步骤 | 描述 | 时间 |
|------|------|------|
| 1 | Edit 工具读取文件内容 | T0 |
| 2 | Edit 工具准备写入修改 | T0 + 100ms |
| 3 | FileSystemWatcher 检测到文件访问 | T0 + 50ms |
| 4 | Watcher 触发"文件变更"事件 | T0 + 80ms |
| 5 | Edit 工具检测到文件已修改 | T0 + 120ms |
| 6 | **报错**: "unexpectedly modified" | T0 + 150ms |

**核心问题**: FileWatcher 的检测速度快于 Edit 工具的写入验证。

### 3.2 为什么 Bash(sed) 能成功

```
Edit 工具路径:
Claude CLI → VSCode Extension Host → FileWatcher → 文件系统
                        ↑                ↑
                        └────────────────┴──── 竞争发生在这里

Bash(sed) 路径:
Claude CLI → Bash → sed 命令 → 直接写入文件系统
                                        ↑
                                        └──── 绕过 VSCode 层，无竞争
```

---

## 4. 解决方案

### 4.1 紧急方案：使用 Bash(sed)

当 Edit 工具反复失败时，使用 `sed` 直接修改文件：

```bash
# 注释掉特定行范围
sed -i '218,231s/^/        # [DISABLED] /' research.ps1

# 替换特定文本
sed -i 's/old_text/new_text/g' file.sh

# 删除特定行
sed -i '10,20d' file.sh
```

### 4.2 实际修改示例

在本次调查中，使用 `sed` 成功修改了两个文件：

**research.sh** (注释掉 Quick 研究代码块):
```bash
sed -i '453,459s/^/#/' research.sh
```

**research.ps1** (添加 DISABLED 前缀):
```bash
sed -i '218,231s/^/        # [DISABLED] /' research.ps1
```

### 4.3 长期建议

| 方案 | 适用场景 | 优缺点 |
|------|---------|--------|
| 继续用 Edit | 单次小修改 | ✅ 直观 / ⚠️ 可能偶发失败 |
| 使用 Bash(sed) | 批量修改、Edit 反复失败 | ✅ 可靠 / ⚠️ 语法复杂 |
| 关闭 VSCode 再修改 | 极少数情况 | ✅ 彻底 / ⚠️ 中断工作流 |

---

## 5. Transferable Rules

### Rule 1: 工具层级识别

**The Pattern**:
```
❌ 错误思路:
   Edit 失败 → "是不是有人在编辑？" → 找不到人 → 困惑

✅ 正确思路:
   Edit 失败 → "工具经过哪些层？" → 识别 Extension Host → 找到竞争点
```

**Why it works**: 现代开发工具有多层架构，问题可能出在任何一层。

**How to apply**:
- 遇到"莫名其妙"的问题 → 画出工具调用链
- 识别每一层的潜在副作用
- 特别注意：Watcher、Hook、Linter 等自动触发机制

---

### Rule 2: 绕过问题层

**The Pattern**:
```
❌ 错误思路:
   在问题层反复尝试 → 失败 → 再试 → 失败 → 时间浪费

✅ 正确思路:
   识别问题层 → 绕过该层 → 用更底层工具完成任务
```

**Why it works**: 有时候修复问题层很难，绕过它更实际。

**How to apply**:
- Edit 工具失败 → 用 Bash(sed) 绕过 VSCode 层
- npm 安装失败 → 用 yarn 或直接下载
- API 超时 → 用 curl 直接请求

---

### Rule 3: 排除法的正确顺序

**The Pattern**:
```
排除顺序（从近到远）:
1. 用户操作 (最容易排除)
2. 配置文件 (Linter, Formatter)
3. 系统级钩子 (Git hooks, File watchers)
4. 工具内部机制 (Extension Host, Runtime)
```

**Why it works**: 从最可能、最容易验证的开始排除，效率最高。

---

## 6. Key Takeaways

### For 使用 Claude Code 的开发者

1. **Edit 反复失败 + 无外部编辑 → 用 `Bash(sed)`**
   ```bash
   sed -i 's/old/new/g' file.sh
   ```

2. **VSCode Extension 环境有隐藏的 FileWatcher**
   - 即使没有打开文件标签页，Watcher 也在运行
   - 这是 Extension Host 的正常行为，不是 bug

3. **sed 常用模式备忘**:
   ```bash
   # 替换文本
   sed -i 's/old/new/g' file

   # 注释行（在行首加 #）
   sed -i '10,20s/^/#/' file

   # 删除行
   sed -i '10,20d' file
   ```

### For 工具开发者

1. **文件操作要考虑 Watcher 竞争**
   - 使用原子写入 (atomic write) 减少竞争窗口
   - 或者在写入前暂停 Watcher

2. **提供绕过选项**
   - 允许用户选择直接文件操作模式
   - 特别是在自动化场景中

### For 调试问题

1. **"没人动过但说被修改了" → 考虑系统级 Watcher**
2. **多层架构 → 画调用链，逐层排查**
3. **排除法顺序：用户 → 配置 → 钩子 → 工具内部**

---

## Glossary

| 术语 | 中文 | 定义 |
|------|------|------|
| **Extension Host** | 扩展宿主 | VSCode 运行扩展的隔离进程 |
| **FileSystemWatcher** | 文件系统监视器 | 监听文件变更的系统组件 |
| **Race Condition** | 竞争条件 | 多个进程/线程同时访问资源导致的不确定行为 |
| **Atomic Write** | 原子写入 | 要么完全写入，要么完全不写入的操作 |
| **sed** | 流编辑器 | Unix 文本处理工具，可直接修改文件 |

---

## Sources

- 实战调查：Claude Code Edit 工具在 VSCode Extension 环境下的文件竞争问题
- 调查对象：`auto-research/_shared/research.sh` 和 `research.ps1` 的修改过程
- 解决方案验证：使用 `Bash(sed)` 成功绕过 VSCode Extension 层完成修改

---

**文档版本**: v1.0.0
**创建日期**: 2025-12-21
**核心教训**: 当工具内部机制产生竞争时，绕过问题层比修复它更实际
